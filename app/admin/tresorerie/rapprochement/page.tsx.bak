'use client'

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { 
  getLignesARapprocher,
  getAllComptesBancaires,
  findMatchingFacturesClientsAmeliore,
  findMatchingFacturesFournisseursAmeliore,
  rapprocherAvecFactureClient,
  rapprocherAvecFactureFournisseur,
  ignorerLigne,
  deRapprocherLigne,
  type LigneBancaire,
  type CompteBancaire
} from '@/lib/firebase/lignes-bancaires'
import { getAllFactures, type Facture } from '@/lib/firebase/factures'
import { getAllFacturesFournisseurs, type FactureFournisseur } from '@/lib/firebase/factures-fournisseurs'

interface SuggestionMatch {
  factureId: string
  factureNumero: string
  clientNom?: string
  fournisseurNom?: string
  montant: number
  difference: number
  confidence: number
  type: 'client' | 'fournisseur'
}

export default function RapprochementPage() {
  const [loading, setLoading] = useState(true)
  const [lignes, setLignes] = useState<LigneBancaire[]>([])
  const [comptes, setComptes] = useState<CompteBancaire[]>([])
  const [selectedLigne, setSelectedLigne] = useState<LigneBancaire | null>(null)
  const [suggestions, setSuggestions] = useState<SuggestionMatch[]>([])
  const [loadingSuggestions, setLoadingSuggestions] = useState(false)
  const [searchMode, setSearchMode] = useState(false)
  const [factures, setFactures] = useState<Facture[]>([])
  const [facturesFournisseurs, setFacturesFournisseurs] = useState<FactureFournisseur[]>([])
  const [searchTerm, setSearchTerm] = useState('')
  
  // Filtres
  const [compteFilter, setCompteFilter] = useState<string>('all')
  const [dateFilter, setDateFilter] = useState<string>('all')

  useEffect(() => {
    loadData()
  }, [])

  async function loadData() {
    try {
      setLoading(true)
      const [lignesData, comptesData, facturesData, facturesFournisseursData] = await Promise.all([
        getLignesARapprocher(),
        getAllComptesBancaires(),
        getAllFactures(),
        getAllFacturesFournisseurs()
      ])
      
      setLignes(lignesData)
      setComptes(comptesData)
      setFactures(facturesData.filter(f => ['envoyee', 'partiellement_payee', 'en_retard'].includes(f.statut)))
      setFacturesFournisseurs(facturesFournisseursData.filter(f => f.statut === 'a_payer'))
    } catch (error) {
      console.error('Erreur chargement donn√©es:', error)
    } finally {
      setLoading(false)
    }
  }

  async function handleAutoRapprochement() {
    if (!confirm('Lancer l\'auto-rapprochement pour toutes les lignes avec une correspondance certaine (confidence 100%) ?')) {
      return
    }
    
    try {
      setLoading(true)
      const response = await fetch('/api/tresorerie/auto-rapprocher', {
        method: 'POST'
      })
      
      const data = await response.json()
      
      if (data.success) {
        alert(`‚úÖ ${data.nombreRapprochees} ligne(s) rapproch√©e(s) automatiquement !`)
        await loadData() // Recharger les donn√©es
      } else {
        alert('Erreur lors de l\'auto-rapprochement')
      }
    } catch (error) {
      console.error('Erreur auto-rapprochement:', error)
      alert('Erreur lors de l\'auto-rapprochement')
    } finally {
      setLoading(false)
    }
  }

  async function selectLigne(ligne: LigneBancaire) {
    setSelectedLigne(ligne)
    setSearchMode(false)
    setSearchTerm('')
    
    // Charger suggestions automatiques
    setLoadingSuggestions(true)
    try {
      const [matchClients, matchFournisseurs] = await Promise.all([
        findMatchingFacturesClientsAmeliore(ligne),
        findMatchingFacturesFournisseursAmeliore(ligne)
      ])
      
      const allSuggestions: SuggestionMatch[] = [
        ...matchClients.map((m: any) => ({ ...m, type: 'client' as const })),
        ...matchFournisseurs.map((m: any) => ({ ...m, type: 'fournisseur' as const }))
      ]
      
      // Trier par confiance d√©croissante
      allSuggestions.sort((a, b) => b.confidence - a.confidence)
      
      setSuggestions(allSuggestions)
    } catch (error) {
      console.error('Erreur chargement suggestions:', error)
      setSuggestions([])
    } finally {
      setLoadingSuggestions(false)
    }
  }

  async function handleRapprocher(suggestion: SuggestionMatch) {
    if (!selectedLigne) return
    
    if (!confirm(`Rapprocher cette ligne avec la facture ${suggestion.factureNumero} ?`)) {
      return
    }
    
    try {
      if (suggestion.type === 'client') {
        await rapprocherAvecFactureClient(
          selectedLigne.id, 
          suggestion.factureId,
          suggestion.factureNumero,
          'Admin' // TODO: Remplacer par nom utilisateur connect√© quand auth disponible
        )
      } else {
        await rapprocherAvecFactureFournisseur(
          selectedLigne.id, 
          suggestion.factureId,
          suggestion.factureNumero,
          'Admin' // TODO: Remplacer par nom utilisateur connect√© quand auth disponible
        )
      }
      
      alert('‚úÖ Rapprochement effectu√©')
      
      // Recharger
      await loadData()
      setSelectedLigne(null)
      setSuggestions([])
    } catch (error) {
      console.error('Erreur rapprochement:', error)
      alert('‚ùå Erreur lors du rapprochement')
    }
  }

  async function handleIgnorer(ligneId: string) {
    if (!confirm('Ignorer cette ligne bancaire ?')) return
    
    try {
      await ignorerLigne(ligneId)
      alert('‚úÖ Ligne ignor√©e')
      await loadData()
      setSelectedLigne(null)
    } catch (error) {
      console.error('Erreur:', error)
      alert('‚ùå Erreur')
    }
  }

  const lignesFiltrees = lignes.filter(ligne => {
    if (compteFilter !== 'all' && ligne.compteBancaireId !== compteFilter) return false
    if (dateFilter !== 'all') {
      const today = new Date()
      const ligneDate = new Date(ligne.date)
      const diffDays = Math.floor((today.getTime() - ligneDate.getTime()) / (1000 * 60 * 60 * 24))
      
      if (dateFilter === '7j' && diffDays > 7) return false
      if (dateFilter === '30j' && diffDays > 30) return false
      if (dateFilter === '90j' && diffDays > 90) return false
    }
    return true
  })

  const searchResults = searchMode ? (
    selectedLigne && selectedLigne.montant > 0 
      ? factures.filter(f => 
          f.numero.toLowerCase().includes(searchTerm.toLowerCase()) ||
          f.clientNom.toLowerCase().includes(searchTerm.toLowerCase())
        )
      : facturesFournisseurs.filter(f =>
          f.numero.toLowerCase().includes(searchTerm.toLowerCase()) ||
          f.fournisseur.toLowerCase().includes(searchTerm.toLowerCase())
        )
  ) : []

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mx-auto"></div>
          <p className="mt-4 text-gray-600">Chargement...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {/* Header */}
      <div className="mb-8 flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Rapprochement Bancaire</h1>
          <p className="text-gray-600 mt-2">
            {lignesFiltrees.length} ligne{lignesFiltrees.length > 1 ? 's' : ''} √† rapprocher
          </p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={handleAutoRapprochement}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2"
          >
            ‚ö° Auto-Rapprocher
          </button>
          <Link 
            href="/admin/tresorerie"
            className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
          >
            ‚Üê Retour
          </Link>
        </div>
      </div>

      {/* Filtres */}
      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Compte bancaire
            </label>
            <select
              value={compteFilter}
              onChange={(e) => setCompteFilter(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="all">Tous les comptes</option>
              {comptes.map(compte => (
                <option key={compte.id} value={compte.id}>
                  {compte.nom} - {compte.banque}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              P√©riode
            </label>
            <select
              value={dateFilter}
              onChange={(e) => setDateFilter(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="all">Toutes les p√©riodes</option>
              <option value="7j">7 derniers jours</option>
              <option value="30j">30 derniers jours</option>
              <option value="90j">90 derniers jours</option>
            </select>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Colonne gauche : Lignes bancaires */}
        <div className="bg-white rounded-lg shadow">
          <div className="p-4 border-b">
            <h2 className="text-lg font-bold text-gray-900">Lignes Bancaires</h2>
          </div>
          
          <div className="divide-y max-h-[600px] overflow-y-auto">
            {lignesFiltrees.length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                ‚úÖ Aucune ligne √† rapprocher
              </div>
            ) : (
              lignesFiltrees.map(ligne => (
                <div
                  key={ligne.id}
                  onClick={() => selectLigne(ligne)}
                  className={`p-4 cursor-pointer hover:bg-blue-50 transition ${
                    selectedLigne?.id === ligne.id ? 'bg-blue-100 border-l-4 border-blue-600' : ''
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className={`px-2 py-1 text-xs rounded font-medium ${
                          ligne.montant > 0 
                            ? 'bg-green-100 text-green-700' 
                            : 'bg-red-100 text-red-700'
                        }`}>
                          {ligne.montant > 0 ? 'CR√âDIT' : 'D√âBIT'}
                        </span>
                        <span className="text-xs text-gray-500">
                          {new Date(ligne.date).toLocaleDateString('fr-FR')}
                        </span>
                      </div>
                      <p className="font-medium text-gray-900 text-sm">
                        {ligne.libelle}
                      </p>
                      {ligne.categorieAuto && (
                        <p className="text-xs text-gray-500 mt-1">
                          üìÇ {ligne.categorieAuto}
                        </p>
                      )}
                    </div>
                    <div className="text-right ml-4">
                      <p className={`font-bold ${
                        ligne.montant > 0 ? 'text-green-600' : 'text-red-600'
                      }`}>
                        {ligne.montant > 0 ? '+' : ''}{ligne.montant.toFixed(2)} ‚Ç¨
                      </p>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>

        {/* Colonne droite : Suggestions / Recherche */}
        <div className="bg-white rounded-lg shadow">
          <div className="p-4 border-b">
            <h2 className="text-lg font-bold text-gray-900">
              {selectedLigne ? 'Rapprochement' : 'S√©lectionner une ligne'}
            </h2>
          </div>

          {!selectedLigne ? (
            <div className="p-8 text-center text-gray-500">
              ‚Üê S√©lectionner une ligne bancaire √† gauche
            </div>
          ) : (
            <div className="p-4">
              {/* D√©tail ligne s√©lectionn√©e */}
              <div className="bg-gray-50 rounded-lg p-4 mb-4">
                <div className="flex items-center justify-between mb-2">
                  <span className={`px-3 py-1 text-sm rounded font-medium ${
                    selectedLigne.montant > 0 
                      ? 'bg-green-100 text-green-700' 
                      : 'bg-red-100 text-red-700'
                  }`}>
                    {selectedLigne.montant > 0 ? 'CR√âDIT' : 'D√âBIT'}
                  </span>
                  <span className="text-sm text-gray-600">
                    {new Date(selectedLigne.date).toLocaleDateString('fr-FR')}
                  </span>
                </div>
                <p className="font-bold text-gray-900">{selectedLigne.libelle}</p>
                <p className="text-2xl font-bold text-gray-900 mt-2">
                  {selectedLigne.montant.toFixed(2)} ‚Ç¨
                </p>
              </div>

              {/* Actions */}
              <div className="flex gap-2 mb-4">
                <button
                  onClick={() => setSearchMode(!searchMode)}
                  className={`flex-1 px-4 py-2 rounded font-medium ${
                    searchMode 
                      ? 'bg-blue-600 text-white' 
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  üîç Recherche manuelle
                </button>
                <button
                  onClick={() => handleIgnorer(selectedLigne.id)}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                >
                  Ignorer
                </button>
              </div>

              {/* Recherche manuelle */}
              {searchMode && (
                <div className="mb-4">
                  <input
                    type="text"
                    placeholder={selectedLigne.montant > 0 
                      ? "Rechercher une facture client..." 
                      : "Rechercher une facture fournisseur..."}
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg"
                  />
                  
                  {searchTerm && (
                    <div className="mt-2 max-h-64 overflow-y-auto border rounded">
                      {searchResults.length === 0 ? (
                        <p className="p-4 text-gray-500 text-center">Aucun r√©sultat</p>
                      ) : (
                        searchResults.map((item: any) => (
                          <div
                            key={item.id}
                            onClick={() => handleRapprocher({
                              factureId: item.id,
                              factureNumero: item.numero,
                              clientNom: item.clientNom,
                              fournisseurNom: item.fournisseur,
                              montant: item.totalTTC || item.montantTTC,
                              difference: Math.abs((item.totalTTC || item.montantTTC) - Math.abs(selectedLigne.montant)),
                              confidence: 50,
                              type: selectedLigne.montant > 0 ? 'client' : 'fournisseur'
                            })}
                            className="p-3 hover:bg-gray-100 cursor-pointer border-b"
                          >
                            <p className="font-medium">{item.numero}</p>
                            <p className="text-sm text-gray-600">
                              {item.clientNom || item.fournisseur}
                            </p>
                            <p className="text-sm font-bold">{(item.totalTTC || item.montantTTC).toFixed(2)} ‚Ç¨</p>
                          </div>
                        ))
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* Suggestions automatiques */}
              {!searchMode && (
                <div>
                  <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                    <span>üí° Suggestions automatiques</span>
                    {loadingSuggestions && (
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    )}
                  </h3>

                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {suggestions.length === 0 ? (
                      <div className="p-4 bg-gray-50 rounded text-center text-gray-500">
                        Aucune suggestion trouv√©e
                      </div>
                    ) : (
                      suggestions.map((suggestion, index) => (
                        <div
                          key={index}
                          className={`p-3 rounded border-2 cursor-pointer transition ${
                            suggestion.confidence >= 90 
                              ? 'border-green-300 bg-green-50 hover:bg-green-100' 
                              : suggestion.confidence >= 70
                              ? 'border-yellow-300 bg-yellow-50 hover:bg-yellow-100'
                              : 'border-gray-300 bg-gray-50 hover:bg-gray-100'
                          }`}
                          onClick={() => handleRapprocher(suggestion)}
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <span className={`px-2 py-1 text-xs rounded font-medium ${
                                  suggestion.confidence >= 90 
                                    ? 'bg-green-600 text-white' 
                                    : suggestion.confidence >= 70
                                    ? 'bg-yellow-600 text-white'
                                    : 'bg-gray-600 text-white'
                                }`}>
                                  {suggestion.confidence}% confiance
                                </span>
                                <span className="text-xs text-gray-600">
                                  {suggestion.type === 'client' ? 'üì§ Client' : 'üì• Fournisseur'}
                                </span>
                              </div>
                              <p className="font-bold text-gray-900">{suggestion.factureNumero}</p>
                              <p className="text-sm text-gray-600">
                                {suggestion.clientNom || suggestion.fournisseurNom}
                              </p>
                              <p className="text-sm text-gray-500 mt-1">
                                Montant: {suggestion.montant.toFixed(2)} ‚Ç¨
                                {suggestion.difference > 0 && (
                                  <span className="text-red-600 ml-2">
                                    (Diff: {suggestion.difference.toFixed(2)} ‚Ç¨)
                                  </span>
                                )}
                              </p>
                            </div>
                            <button className="ml-2 px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                              Rapprocher
                            </button>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
