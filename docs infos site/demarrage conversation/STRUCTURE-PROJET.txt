STRUCTURE COMPLÈTE DU PROJET SOLAIRE NETTOYAGE
==============================================
Date : 29 Décembre 2024
Projet : Site professionnel + ERP sur-mesure
Stack : Next.js 14 + Firebase + Vercel

═══════════════════════════════════════════════════════════════════════════════
1. ARCHITECTURE GLOBALE
═══════════════════════════════════════════════════════════════════════════════

HIÉRARCHIE MÉTIER :
GROUPE → CLIENT → SITE → DEVIS/FACTURES/INTERVENTIONS

TECHNOLOGIES :
- Frontend : Next.js 14 (App Router), TypeScript, Tailwind CSS
- Backend : Firebase Firestore, Firebase Storage
- Email : Nodemailer (SMTP IONOS), IMAP (rapports Praxedo)
- PDF : jsPDF + autotable
- Déploiement : Vercel (production)
- VPS : IONOS avec Plesk (futur)

═══════════════════════════════════════════════════════════════════════════════
2. STRUCTURE DES DOSSIERS
═══════════════════════════════════════════════════════════════════════════════

/
├── app/                          # Pages Next.js (App Router)
│   ├── admin/                    # Interface administrateur
│   │   ├── affectation-masse/   # Affectation interventions en masse
│   │   ├── articles/             # Gestion catalogue articles
│   │   ├── calendrier/           # Calendrier interventions
│   │   ├── demandes-modifications/ # Demandes clients
│   │   ├── devis/                # Module devis complet
│   │   │   ├── [id]/            # Détail + modification devis
│   │   │   ├── nouveau/         # Création nouveau devis
│   │   │   └── page.tsx         # Liste devis
│   │   ├── gely/                # GELY Management (finances)
│   │   ├── gestion-clients/     # CRUD clients
│   │   ├── gestion-equipes/     # Gestion équipes terrain
│   │   ├── gestion-groupes/     # CRUD groupes
│   │   ├── gestion-operateurs/  # Gestion opérateurs
│   │   ├── gestion-sites/       # CRUD sites
│   │   ├── gestion-techniciens/ # Gestion techniciens
│   │   ├── import-sites/        # Import Excel massif sites
│   │   ├── init-equipes/        # Initialisation équipes
│   │   ├── init-operateurs/     # Initialisation opérateurs
│   │   ├── interventions/       # Détail interventions
│   │   ├── nouvelle-intervention/ # Créer intervention
│   │   ├── parametres-entreprise/ # Infos légales entreprise
│   │   └── upload-rapport/      # Upload manuel rapport
│   ├── api/                      # API Routes
│   │   ├── devis/
│   │   │   └── [id]/
│   │   │       ├── pdf/         # Génération PDF devis
│   │   │       └── send-email/  # Envoi email devis
│   │   ├── interventions/
│   │   │   └── parse-excel/     # Parse Excel interventions
│   │   └── rapports/
│   │       ├── extract-site/    # Extraction nom site PDF
│   │       ├── parse-pdf/       # Parse PDF rapport Praxedo
│   │       ├── sync-emails/     # Sync emails Praxedo (IMAP)
│   │       └── test-pdf/        # Test parsing PDF
│   ├── client/                   # Interface clients
│   │   ├── dashboard/           # Dashboard client
│   │   ├── demande-acces/       # Demande accès client
│   │   ├── interventions/       # Consulter interventions
│   │   └── login/               # Connexion client
│   ├── entreprise/               # Pages publiques entreprise
│   │   ├── a-propos/
│   │   ├── carrieres/
│   │   ├── certifications/
│   │   └── references/
│   ├── intranet/                 # Intranet équipes
│   │   ├── certifications/      # Gestion certifications CACES/VGP
│   │   ├── dashboard/           # Dashboard intranet
│   │   ├── extincteurs/         # Gestion extincteurs
│   │   └── login/               # Connexion intranet
│   ├── services/                 # Services détaillés
│   │   ├── centrales-sol/
│   │   ├── ombrieres/
│   │   ├── seveso/
│   │   └── toitures/
│   ├── technicien/               # Interface techniciens
│   │   ├── extincteurs/         # Vérification extincteurs terrain
│   │   └── login/               # Connexion technicien
│   ├── components/               # Composants partagés
│   ├── globals.css              # Styles globaux
│   ├── layout.tsx               # Layout principal
│   ├── notre-histoire/          # Page histoire entreprise
│   └── page.tsx                 # Page d'accueil
├── components/                   # Composants réutilisables
│   ├── gely/                    # Composants GELY Management
│   │   ├── Dashboard.tsx
│   │   ├── PlanPrevisionnel20ans.tsx
│   │   ├── DashboardGroupe.tsx
│   │   └── [autres composants finances]
│   ├── ImportInterventionsModal.tsx
│   ├── MapView.tsx              # Carte interactive sites
│   └── SyncRapportsButton.tsx   # Bouton sync rapports
├── lib/                          # Bibliothèques utilitaires
│   ├── firebase/                # Firebase SDK & fonctions
│   │   ├── config.ts           # Configuration Firebase
│   │   ├── articles.ts         # CRUD articles
│   │   ├── certifications.ts   # Gestion certifications
│   │   ├── clients.ts          # CRUD clients
│   │   ├── demandes.ts         # Demandes modifications
│   │   ├── devis.ts            # CRUD devis + calculs
│   │   ├── documents.ts        # Gestion documents
│   │   ├── emails.ts           # Historique emails
│   │   ├── entreprise.ts       # Paramètres entreprise
│   │   ├── extincteurs.ts      # Gestion extincteurs
│   │   ├── groupes.ts          # CRUD groupes
│   │   ├── import-sites.ts     # Import Excel sites
│   │   ├── interventions.ts    # CRUD interventions
│   │   ├── interventions-calendar.ts # Calendrier
│   │   ├── operateurs.ts       # Gestion opérateurs
│   │   ├── sites.ts            # CRUD sites
│   │   └── storage.ts          # Firebase Storage
│   ├── gely/                    # Logique GELY Management
│   │   ├── types.ts
│   │   ├── mockData.ts
│   │   └── useFirestore.ts
│   └── certifications-data.ts   # Data certifications
├── public/                       # Assets statiques
├── .env.local                    # Variables environnement locales
├── .gitignore
├── next.config.js
├── package.json
├── tailwind.config.ts
└── tsconfig.json

═══════════════════════════════════════════════════════════════════════════════
3. COLLECTIONS FIREBASE
═══════════════════════════════════════════════════════════════════════════════

COLLECTIONS PRINCIPALES :

▸ groupes
  - id, nom, contactPrincipal, siret, adresse, ville, codePostal
  - Gestion des groupes de clients (ex: LEXA, MECOJIT)

▸ clients
  - id, company, groupeId, groupeNom, siret, adresse, contact
  - active (boolean - filtre clients actifs)
  - Hiérarchie : Groupe → Client

▸ sites
  - id, clientId, nomSite, complementNom, surface
  - adresse, ville, codePostal, lat, lng
  - puissance, typeInstallation
  - Hiérarchie : Client → Site

▸ articles
  - id, code (NM04, NM05...), nom, description
  - prix, unite, tva, actif (boolean)
  - Catalogue articles facturation

▸ devis
  - id, numero, clientId, clientNom, groupeId, groupeNom
  - lignes: [{siteId, siteNom, surfaceM2, articleId, quantite, prixUnitaire, tva, totaux}]
  - totaux: {totalHT, totalTVA, totalTTC}
  - statut: brouillon, en_attente, valide, refuse, envoye
  - notes, dateCreation, dateModification

▸ interventions
  - id, siteId, siteName, clientId, clientName
  - date, equipe, operateurs
  - statut, notes, rapportPDF
  - Lien avec rapports Praxedo

▸ interventions_calendar
  - id, title, start, end, allDay
  - siteId, siteName, clientId, clientName
  - equipeId, equipeNom
  - Calendrier interventions

▸ emails_historique
  - id, devisId, destinataire, subject, body
  - datEnvoi, statut, error
  - Historique envois emails devis

▸ entreprise
  - id: "default"
  - nom, siret, adresse, siege social
  - rcs, capital, tvaIntracom
  - logo, signature, conditions
  - Paramètres entreprise pour PDF/emails

▸ equipes
  - id, nom, couleur
  - Équipes terrain

▸ operateurs
  - id, nom, prenom, email, telephone
  - equipeId, actif
  - Opérateurs terrain

▸ certifications
  - id, type (CACES, medical, VGP)
  - technicienId, dateObtention, dateExpiration
  - statut, document
  - Gestion certifications équipes

▸ extincteurs
  - id, numero, emplacement, type
  - dateVerification, dateExpiration
  - technicienId, statut
  - Gestion extincteurs sites

▸ demandes_modifications
  - id, clientId, type, description
  - statut, dateCreation, dateTraitement
  - Demandes clients dataroom

COLLECTIONS GELY MANAGEMENT :

▸ projets
  - id, nom, type, societe
  - montantInvestissement, dateDebut
  - fluxFinanciers, documents
  - Projets investissements groupe

═══════════════════════════════════════════════════════════════════════════════
4. ROUTES API PRINCIPALES
═══════════════════════════════════════════════════════════════════════════════

POST /api/devis/[id]/pdf
  → Génère PDF devis avec jsPDF + autotable
  → Retourne base64 ou blob

POST /api/devis/[id]/send-email
  → Génère PDF + Envoie email SMTP IONOS
  → Enregistre historique dans emails_historique
  → SMTP : contact@solairenettoyage.fr / lexa130173

POST /api/interventions/parse-excel
  → Parse Excel interventions
  → Import massif interventions

POST /api/rapports/sync-emails
  → Connexion IMAP rapports@solairenettoyage.fr
  → Récupère emails non lus Praxedo
  → Télécharge PDF rapports
  → Parse et match avec interventions
  → IMAP : rapports@solairenettoyage.fr / Lexa-130173!

POST /api/rapports/parse-pdf
  → Parse PDF rapport Praxedo
  → Extrait données intervention

POST /api/rapports/extract-site
  → Extrait nom site du PDF
  → Matching intelligent avec base sites

═══════════════════════════════════════════════════════════════════════════════
5. VARIABLES D'ENVIRONNEMENT
═══════════════════════════════════════════════════════════════════════════════

FIREBASE (publiques dans code) :
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyBRpg61WI9-I-RcnhVJehTDCbUJPP8oAno
NEXT_PUBLIC_FIREBASE_PROJECT_ID=solaire-dataroom

EMAIL PRAXEDO (IMAP - réception rapports) :
EMAIL_USER=rapports@solairenettoyage.fr
EMAIL_PASSWORD=Lexa-130173!

SMTP IONOS (envoi devis) :
SMTP_HOST=smtp.ionos.fr
SMTP_PORT=465
SMTP_USER=contact@solairenettoyage.fr
SMTP_PASSWORD=lexa130173

URLs :
NEXT_PUBLIC_BASE_URL=http://localhost:3000 (local) ou URL Vercel
NEXT_PUBLIC_APP_URL=https://solairenettoyage.com

═══════════════════════════════════════════════════════════════════════════════
6. MODULES OPÉRATIONNELS
═══════════════════════════════════════════════════════════════════════════════

✅ GELY MANAGEMENT
   - Dashboard groupe multi-sociétés
   - Plans prévisionnels 20 ans
   - Flux inter-sociétés automatiques
   - Calculs investissements
   - Gestion documents projets

✅ INTERVENTIONS & RAPPORTS
   - Calendrier complet
   - Affectation équipes/opérateurs
   - Synchronisation automatique Praxedo (IMAP)
   - Parsing intelligent PDF
   - Matching interventions par nom site

✅ CLIENTS/SITES/GROUPES
   - Hiérarchie complète
   - Import Excel massif
   - Détection doublons
   - Interface gestion complète

✅ ARTICLES
   - Catalogue complet
   - Prix, TVA, descriptions
   - Actif/Inactif

✅ DEVIS COMPLET
   - Création/modification multi-lignes
   - Calculs automatiques HT/TVA/TTC
   - Génération PDF professionnelle
   - Envoi email SMTP avec PJ
   - Historique envois
   - Workflow : brouillon → en_attente → validé/refusé

✅ PARAMÈTRES ENTREPRISE
   - Infos légales complètes
   - Logo, signature
   - Conditions générales

✅ CERTIFICATIONS
   - CACES, visites médicales
   - VGP équipements
   - Alertes expiration

✅ EXTINCTEURS
   - Gestion complète
   - Vérifications périodiques
   - Interface techniciens terrain

═══════════════════════════════════════════════════════════════════════════════
7. CORRECTIONS IMPORTANTES APPLIQUÉES
═══════════════════════════════════════════════════════════════════════════════

CORRECTION 1 - CHAMPS CLIENTS :
Avant : client.nom, client.groupe
Après : client.company, client.groupeNom
Raison : Cohérence avec structure Firebase

CORRECTION 2 - CHAMPS SITES :
Avant : site.nom, site.surface_m2
Après : site.nomSite || site.complementNom || site.nom, site.surface
Raison : Sites importés Excel ont nomSite/complementNom

CORRECTION 3 - CLIENTS ACTIFS :
Avant : clients.filter(c => c.actif)
Après : clients.filter(c => c.active !== false)
Raison : Champ "active" pas "actif"

CORRECTION 4 - FIREBASE UNDEFINED :
Ajout filtrage champs undefined dans createDevis/updateDevis
Raison : Firebase refuse valeurs undefined

CORRECTION 5 - SMTP IONOS :
Port 465 (SSL/TLS) au lieu de 587 (STARTTLS)
Mots de passe : lexa130173 (contact@), Lexa-130173! (rapports@)
Raison : Configuration spécifique IONOS

CORRECTION 6 - TYPESCRIPT PDF :
Champ Adresse.rue au lieu de Adresse.adresse
Raison : Interface Adresse utilise "rue"

CORRECTION 7 - COULEURS LISIBILITÉ :
text-gray-900 → text-black + style inline
Raison : Visibilité select clients/sites/articles

═══════════════════════════════════════════════════════════════════════════════
8. DÉPENDANCES PRINCIPALES (package.json)
═══════════════════════════════════════════════════════════════════════════════

PRODUCTION :
- next@14.2.0
- react@18 + react-dom@18
- firebase@10.13.2
- jspdf@2.5.2
- jspdf-autotable@3.8.4
- nodemailer@6.9.16
- imap@0.8.19
- pdf-parse@1.1.1
- xlsx@0.18.5
- react-big-calendar@1.15.0
- lucide-react (icons)
- date-fns (dates)

DEV :
- typescript@5
- @types/node, @types/react
- tailwindcss@3
- eslint

═══════════════════════════════════════════════════════════════════════════════
9. WORKFLOW TYPIQUE
═══════════════════════════════════════════════════════════════════════════════

1. CRÉATION DEVIS :
   Admin → Devis → Nouveau
   → Sélectionne client (charge sites du client)
   → Ajoute lignes (site + article + quantité)
   → Calculs auto HT/TVA/TTC
   → Enregistre brouillon
   → Génère PDF
   → Envoie email client avec PDF
   → Historique enregistré Firebase

2. GESTION INTERVENTIONS :
   Admin → Calendrier
   → Crée intervention (site, équipe, date)
   → Affecte opérateurs
   → Praxedo génère rapport terrain
   → Email envoyé à rapports@
   → Sync automatique récupère PDF
   → Parse et associe à intervention
   → Visible dans dashboard

3. IMPORT SITES CLIENT :
   Admin → Import Sites
   → Upload Excel client (format spécifique)
   → Parse colonnes (nomSite, surface, GPS, etc.)
   → Détection doublons par complementNom
   → Import ou mise à jour
   → Sites visibles immédiatement

═══════════════════════════════════════════════════════════════════════════════
10. PROCHAINES ÉTAPES
═══════════════════════════════════════════════════════════════════════════════

COURT TERME :
1. Module Factures (similaire devis, numérotation auto)
2. Workflow Devis → Intervention automatique

MOYEN TERME :
3. Module CRM COMPLET PROFESSIONNEL
   - Pipeline commercial avancé
   - Historique contacts
   - Suivi opportunités
   - Relances automatiques
   - Statistiques commerciales
   - Intégration email/téléphone

4. Tableaux de bord analytiques
5. Reporting avancé

LONG TERME :
6. Déploiement VPS final (si besoin)
7. API REST publique
8. Application mobile terrain

═══════════════════════════════════════════════════════════════════════════════
FIN DE DOCUMENTATION
═══════════════════════════════════════════════════════════════════════════════

Dernière mise à jour : 29 Décembre 2024
Projet : Solaire Nettoyage - ERP sur-mesure
Contact : Jerome Gely
